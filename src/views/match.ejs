<!DOCTYPE html>
<html>
  <%- include('partials/head.ejs', {pageTitle: "Match View"}) %>
  <body>
    <%- include('partials/nav.ejs') %>
    <div class="container">
      <h1 class="header">
        Match <% match.players?.forEach((p,idx)=> { %>
        <span class="pill player<%=idx%> <%=(match?.currentPlayerId==p?'activePlayer':'')%>"
          ><%= players.get(p)?.name %></span
        >
        <% }); %>
        <span class="badge"><%= match.isFinished ? "Finished" : "Ongoing" %></span>
        <span class="badge"><%= match.id %></span>
      </h1>

      <a class="btn" href="#!" onClick="history.go(0);">Refresh</a>
      <table>
        <% moves?.reduceRight( (_,move) => { %>
        <tbody class="movebody">
          <% let hevent = move.events.at(0); %>
          <tr class="moveheader player<%= hevent.currentPlayerIndex %>">
            <td class="bar"></td>
            <td>
              <span class="eventType"><%= hevent.eventType %></span>
              <div class="datepill"><%= move.at?.toLocaleTimeString() %></div>
            </td>
            <td><%= JSON.stringify(fnSanitizeEvent(hevent)).trim("{") %></td>
          </tr>
          <% move.events.slice(1).reduce( (_,event) => { %>
          <tr class="player<%= event.currentPlayerIndex %>">
            <td class="bar"></td>
            <td><%= event.eventType %></td>
            <td><%= JSON.stringify(fnSanitizeEvent(event)) %></td>
          </tr>
          <% }, null); %>
        </tbody>
        <% }, null); %>
      </table>
    </div>
  </body>
</html>
